# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Test Dockerfiles

on:
  push:
    branches: ["main", "master"]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: ["main"]

permissions:
  contents: read
  id-token: write

jobs:
  test:
    env:
      CONTAINER_NAME: "liquibase"

    strategy:
      fail-fast: false
      matrix:
        dockerfile: [Dockerfile, Dockerfile.alpine, DockerfileSecure]
        os: [ubuntu-latest, macos-15-intel]

    name: Build & Test ${{ matrix.dockerfile }} - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Docker on macOS
        if: matrix.os == 'macos-15-intel'
        uses: douglascamata/setup-docker-macos-action@v1.0.2
            
      - name: Build an image from ${{ matrix.dockerfile }}
        run: |
          docker build -f ${{ matrix.dockerfile }} -t liquibase/liquibase:${{ github.sha }} .

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Test liquibase init start-h2
        run: |
          LOG_STRING="The database does not persist data"
          docker run --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} --name $CONTAINER_NAME -d -v $(pwd)/.github/test:/liquibase/changelog liquibase/liquibase:${{ github.sha }} init start-h2
          sleep 30
          # Check if the container is running
          if docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null | grep -q "true"; then
              # Get the logs and check if the desired string is present
              if docker logs "$CONTAINER_NAME" 2>&1 | grep -q "$LOG_STRING"; then
                  echo "The log contains the string: $LOG_STRING"
              else
                  echo "The log does not contain the string: $LOG_STRING"
                  exit 1
              fi
          else
              echo "Error: Container $CONTAINER_NAME is not running."
              exit 2
          fi

      - name: Test liquibase version
        run: |
          LOG_STRING="Starting Liquibase"
          # Check if the container is running
          if docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null | grep -q "true"; then
              # Get the logs and check if the desired string is present
              if docker exec $CONTAINER_NAME liquibase --version 2>&1 | grep -q "$LOG_STRING"; then
                  echo "The log contains the string: $LOG_STRING"
              else
                  echo "The log does not contain the string: $LOG_STRING"
                  exit 1
              fi
          else
              echo "Error: Container $CONTAINER_NAME is not running."
              exit 2
          fi

      - name: Test liquibase update
        run: |
          LOG_STRING="Update has been successful"
          # Check if the container is running
          if docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null | grep -q "true"; then
              # Get the logs and check if the desired string is present
              if docker exec $CONTAINER_NAME liquibase update --defaultsFile=/liquibase/changelog/liquibase.properties --changelog-file=/changelog/example-changelog.xml 2>&1 | grep -q "$LOG_STRING"; then
                  echo "The log contains the string: $LOG_STRING"
              else
                  echo "The log does not contain the string: $LOG_STRING"
                  exit 1
              fi
          else
              echo "Error: Container $CONTAINER_NAME is not running."
              exit 2
          fi

      - name: Test liquibase wrong ENV variable
        run: |
          LOG_STRING="Error: Unable to access jarfile wrong_path/internal/lib/"
          # Stop docker container and remove it
          docker stop $CONTAINER_NAME
          docker rm $CONTAINER_NAME
          # Start docker container with wrong ENV
          # Get the logs and check if the desired string is present
          if docker run --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} --name $CONTAINER_NAME -d -v $(pwd)/.github/test:/liquibase/changelog -e LIQUIBASE_HOME="wrong_path" liquibase/liquibase:${{ github.sha }} init start-h2 2>&1 | grep -q "$LOG_STRING"; then
            echo "The log does not contain the string: $LOG_STRING"
            exit 1
          else
            echo "The log contains the string: $LOG_STRING"
          fi

      - name: Test liquibase good ENV variable
        run: |
          LOG_STRING="The database does not persist data"
          # Stop docker container and remove it
          docker stop $CONTAINER_NAME
          docker rm $CONTAINER_NAME
          # Start docker container with good ENV
          docker run --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} --name $CONTAINER_NAME -d -v $(pwd)/.github/test:/liquibase/changelog -e LIQUIBASE_HOME="/liquibase" liquibase/liquibase:${{ github.sha }} init start-h2
          sleep 30
          docker logs $CONTAINER_NAME
          # Check if the container is running
          if docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null | grep -q "true"; then
              # Get the logs and check if the desired string is present
              if docker logs "$CONTAINER_NAME" 2>&1 | grep -q "$LOG_STRING"; then
                  echo "The log contains the string: $LOG_STRING"
              else
                  echo "The log does not contain the string: $LOG_STRING"
                  exit 1
              fi
          else
              echo "Error: Container $CONTAINER_NAME is not running."
              exit 2
          fi

      - name: Test volume persistence
        run: |
          LOG_STRING="Update has been successful"
          # Stop docker container
          docker stop $CONTAINER_NAME
          # Start docker container
          docker start $CONTAINER_NAME
          sleep 30
          # Check if the container is running
          if docker inspect -f '{{.State.Running}}' "$CONTAINER_NAME" 2>/dev/null | grep -q "true"; then
              # Get the logs and check if the desired string is present
              if docker exec $CONTAINER_NAME liquibase update --defaultsFile=/liquibase/changelog/liquibase.properties --changelog-file=/changelog/example-changelog.xml 2>&1 | grep -q "$LOG_STRING"; then
                  echo "The log contains the string: $LOG_STRING"
              else
                  echo "The log does not contain the string: $LOG_STRING"
                  exit 1
              fi
          else
              echo "Error: Container $CONTAINER_NAME is not running."
              exit 2
          fi

      - name: Test extension loading
        run: |
          LOG_STRING="liquibase-redshift"
          # Stop docker container
          docker exec $CONTAINER_NAME lpm add liquibase-redshift --category=extension -g
          # Get the logs and check if the desired string is present
          if docker exec $CONTAINER_NAME liquibase --version 2>&1 | grep -q "$LOG_STRING"; then
              echo "The log contains the string: $LOG_STRING"
          else
              echo "The log does not contain the string: $LOG_STRING"
              exit 1
          fi

      - name: Test driver connection
        run: |
          LOG_STRING="successfully installed in classpath"
          docker stop $CONTAINER_NAME
          docker rm $CONTAINER_NAME
          docker network create --driver bridge test_network
          # Get the logs and check if the desired string is present
          docker run -d --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} --name $CONTAINER_NAME --network test_network -v $(pwd)/.github/test:/liquibase/changelog liquibase/liquibase:${{ github.sha }} init start-h2
          if docker exec $CONTAINER_NAME lpm add mssql --category=driver -g 2>&1 | grep -q "$LOG_STRING"; then
              echo "The log contains the string: $LOG_STRING"
          else
              echo "The log does not contain the string: $LOG_STRING"
              exit 1
          fi

      - name: Test custom entrypoint
        run: |
          LOG_STRING="Update has been successful"
          # Build auxiliary liquibase image to inherit from
          docker build -f ${{ matrix.dockerfile }} -t liquibase:test-entrypoint .
          # Build custom liquibase image
          docker build -f $(pwd)/.github/test/Dockerfile -t liquibase:test $(pwd)/.github/test/
          # Get the logs and check if the desired string is present
          docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} --name liquibase-test --entrypoint="/scripts/liquibase_command.sh" -v $(pwd)/.github/test:/liquibase/changelog liquibase:test "version"

      # CLI-Docker Compatibility Feature Tests
      - name: Test CLI-Docker compatibility - Working directory change
        run: |
          echo "Testing that working directory changes to /liquibase/changelog when mounted..."
          
          # Stop and remove existing container
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          
          # Create test directory with a properties file to verify working directory
          mkdir -p test-compatibility
          cat > test-compatibility/test.properties << EOF
          changelogFile=test-changelog.xml
          url=offline:postgresql
          driver=org.postgresql.Driver
          EOF
          
          cat > test-compatibility/test-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <sql>SELECT 'Test';</sql>
              </changeSet>
          </databaseChangeLog>
          EOF
          
          # Test that working directory changes when /liquibase/changelog is mounted
          # If working directory changed, it should find test.properties with relative path
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-compatibility:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            --defaultsFile=test.properties validate 2>&1)
          
          echo "Container output: $RESULT"
          
          # If working directory changed correctly, validation should succeed
          if echo "$RESULT" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Working directory correctly changed to mounted changelog directory"
          else
            echo "❌ FAIL: Working directory did not change to changelog directory or validation failed"
            echo "This indicates the properties file was not found with relative path"
            exit 1
          fi
          
          # Cleanup
          rm -rf test-compatibility

      - name: Test CLI-Docker compatibility - Relative path file creation  
        run: |
          echo "Testing relative path file creation with new CLI-Docker compatibility..."
          
          # Create test directory structure
          mkdir -p test-file-creation
          cat > test-file-creation/test-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <createTable tableName="test_table">
                      <column name="id" type="int"/>
                  </createTable>
              </changeSet>
          </databaseChangeLog>
          EOF
          
          # Test updateSQL with relative path to generate SQL output file
          docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-file-creation:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            updateSQL --changelogFile=test-changelog.xml --url=offline:postgresql --outputFile=generated-update.sql
          
          # Verify file was created in the mounted directory (not container root)
          if [ -f "test-file-creation/generated-update.sql" ]; then
            echo "✅ SUCCESS: File created in mounted directory with relative path"
            echo "File contents preview:"
            head -5 test-file-creation/generated-update.sql
          else
            echo "❌ FAIL: File not created in expected location"
            echo "Files in test directory:"
            ls -la test-file-creation/
            # Also check if the file was created in container root (wrong location)
            echo "Testing if file was created in wrong location..."
            WRONG_LOCATION=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-file-creation:/liquibase/changelog \
              liquibase/liquibase:${{ github.sha }} \
              sh -c "ls -la /liquibase/generated-update.sql 2>/dev/null || echo 'NOT_FOUND'")
            echo "Check for file in container root: $WRONG_LOCATION"
            exit 1
          fi
          
          # Cleanup
          rm -rf test-file-creation

      - name: Test CLI-Docker compatibility - Properties file resolution
        run: |
          echo "Testing properties file resolution with relative paths..."
          
          # Create test directory with properties file
          mkdir -p test-properties
          cat > test-properties/test.properties << EOF
          changelogFile=test-changelog.xml
          url=offline:postgresql
          driver=org.postgresql.Driver
          EOF
          
          cat > test-properties/test-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <comment>Test changeset</comment>
                  <sql>SELECT 'Test';</sql>
              </changeSet>
          </databaseChangeLog>
          EOF
          
          # Test that properties file can be resolved with relative path
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-properties:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            --defaultsFile=test.properties validate 2>&1)
          
          echo "Validation result: $RESULT"
          
          if echo "$RESULT" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Properties file resolved correctly with relative path"
          else
            echo "❌ FAIL: Properties file resolution failed"
            exit 1
          fi
          
          # Cleanup
          rm -rf test-properties

      - name: Test backward compatibility - No changelog directory
        run: |
          echo "Testing backward compatibility when no /liquibase/changelog is mounted..."
          
          # Test container works normally without changelog mount (backward compatibility)
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} liquibase/liquibase:${{ github.sha }} --version 2>&1)
          
          echo "Container output: $RESULT"
          
          if echo "$RESULT" | grep -q "Liquibase.*Version"; then
            echo "✅ SUCCESS: Container works without changelog mount (backward compatible)"
          else
            echo "❌ FAIL: Container broken when no changelog directory mounted"
            echo "Full output: $RESULT"
            exit 1
          fi

      - name: Test backward compatibility - Mixed path usage scenarios
        run: |
          echo "Testing mixed path usage scenarios work correctly..."
          
          # Create test setup  
          mkdir -p test-mixed-paths
          cat > test-mixed-paths/test-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <sql>SELECT 'Test';</sql>
              </changeSet>
          </databaseChangeLog>
          EOF
          
          # Test 1: Relative path should work (new CLI-Docker compatibility feature)
          echo "Testing relative path (new CLI-Docker compatibility)..."
          RESULT1=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-mixed-paths:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            validate --changelogFile=test-changelog.xml --url=offline:postgresql 2>&1)
          
          if echo "$RESULT1" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Relative paths work with CLI-Docker compatibility"
          else
            echo "❌ FAIL: Relative paths don't work"
            echo "Output: $RESULT1"
            exit 1
          fi
          
          # Test 2: Using SHOULD_CHANGE_DIR=false should preserve old behavior
          echo "Testing SHOULD_CHANGE_DIR=false preserves old behavior..."
          RESULT2=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} --env SHOULD_CHANGE_DIR=false \
            -v $(pwd)/test-mixed-paths:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            validate --changelogFile=test-changelog.xml --url=offline:postgresql 2>&1)
          
          if echo "$RESULT2" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: SHOULD_CHANGE_DIR=false preserves old behavior"
          else
            echo "✅ EXPECTED: SHOULD_CHANGE_DIR=false correctly prevents automatic directory changes"
            echo "This confirms the environment variable override works correctly"
          fi
          
          # Test 3: Verify files are generated in mounted directory with relative paths
          echo "Testing file generation goes to mounted directory..."
          docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} \
            -v $(pwd)/test-mixed-paths:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            update-sql --changelogFile=test-changelog.xml --url=offline:postgresql --output-file=generated-sql.sql
          
          if [ -f "test-mixed-paths/generated-sql.sql" ]; then
            echo "✅ SUCCESS: Generated files are created in mounted directory"
            echo "File contents preview:"
            head -5 test-mixed-paths/generated-sql.sql
          else
            echo "❌ FAIL: Generated file not found in mounted directory"
            ls -la test-mixed-paths/
            exit 1
          fi
          
          # Cleanup
          rm -rf test-mixed-paths

      - name: Test CLI-Docker compatibility - Generate changelog creates files in mounted directory
        run: |
          echo "Testing that generate-changelog command creates files in mounted directory..."
          
          # Create test directory for generate-changelog
          mkdir -p test-generate-changelog
          
          # Create a properties file for the test
          cat > test-generate-changelog/liquibase.properties << EOF
          url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1
          username=sa
          password=
          driver=org.h2.Driver
          EOF
          
          # First, create a basic table in the database and capture it as changelog  
          # Run generate-changelog with relative path
          echo "Running generate-changelog command with relative path..."
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-generate-changelog:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            generate-changelog \
            --defaultsFile=liquibase.properties \
            --changelog-file=generated-changelog.xml 2>&1)
          
          echo "Generate changelog result: $RESULT"
          
          # Check if the command executed successfully (even if no changes to generate)
          if echo "$RESULT" | grep -q "was executed successfully"; then
            echo "✅ SUCCESS: generate-changelog command executed successfully"
          else
            echo "❌ FAIL: generate-changelog command failed"
            echo "Full output: $RESULT"
            exit 1
          fi
          
          # Test generate-changelog with output file creation using updateSQL 
          echo "Testing file generation with updateSQL (which will create output)..."
          
          # Create a simple changelog to generate SQL from
          cat > test-generate-changelog/test-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <createTable tableName="test_table">
                      <column name="id" type="int"/>
                      <column name="name" type="varchar(255)"/>
                  </createTable>
              </changeSet>
          </databaseChangeLog>
          EOF
          
          # Generate SQL output file with relative path to verify file creation works
          docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-generate-changelog:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            update-sql \
            --changelog-file=test-changelog.xml \
            --url=jdbc:h2:mem:testdb \
            --username=sa \
            --output-file=generated-output.sql
          
          # Verify the output file was created in the mounted directory
          if [ -f "test-generate-changelog/generated-output.sql" ]; then
            echo "✅ SUCCESS: Output file created in mounted directory using relative path"
            echo "Generated file contents preview:"
            head -10 test-generate-changelog/generated-output.sql
            
            # Verify file contains expected SQL
            if grep -q "CREATE TABLE.*test_table" test-generate-changelog/generated-output.sql; then
              echo "✅ SUCCESS: Generated file contains expected SQL content"
            else
              echo "❌ FAIL: Generated file does not contain expected SQL content"
              exit 1
            fi
          else
            echo "❌ FAIL: Output file was not created in the mounted directory"
            echo "Files in test directory:"
            ls -la test-generate-changelog/
            exit 1
          fi
          
          # Test with defaults file using relative paths
          echo "Testing generate-changelog with defaults file containing relative paths..."
          
          # Create a defaults file that uses relative paths
          cat > test-generate-changelog/generate.properties << EOF
          changelog-file=another-generated-changelog.xml
          url=jdbc:h2:mem:testdb
          username=sa
          driver=org.h2.Driver
          EOF
          
          # Run generate-changelog using defaults file with relative path
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-generate-changelog:/liquibase/changelog \
            liquibase/liquibase:${{ github.sha }} \
            generate-changelog \
            --defaults-file=generate.properties 2>&1)
          
          echo "Generate changelog with defaults file result: $RESULT"
          
          # Verify the command executed successfully 
          if echo "$RESULT" | grep -q "was executed successfully"; then
            echo "✅ SUCCESS: generate-changelog with defaults file using relative paths works"
          else
            echo "❌ FAIL: generate-changelog with defaults file failed"
            echo "Full output: $RESULT"
            exit 1
          fi
          
          # Cleanup
          rm -rf test-generate-changelog

      - name: Test CLI-Docker compatibility - Complex scenario  
        run: |
          echo "Testing complex scenario with multiple relative paths..."
          
          # Create complex test structure
          mkdir -p test-complex/{changelog,lib}
          
          cat > test-complex/changelog/db.changelog-root.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <include file="001-tables.xml" relativeToChangelogFile="true"/>
          </databaseChangeLog>
          EOF
          
          cat > test-complex/changelog/001-tables.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <createTable tableName="test_table">
                      <column name="id" type="int"/>
                  </createTable>
              </changeSet>
          </databaseChangeLog>
          EOF
          
          cat > test-complex/app.properties << EOF
          changelogFile=db.changelog-root.xml  
          url=offline:postgresql
          driver=org.postgresql.Driver
          EOF
          
          # Test complex scenario with includes and relative paths
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} -v $(pwd)/test-complex/changelog:/liquibase/changelog -v $(pwd)/test-complex:/liquibase/app \
            liquibase/liquibase:${{ github.sha }} \
            --defaultsFile=../app/app.properties validate 2>&1)
          
          echo "Complex validation result: $RESULT"  
          
          if echo "$RESULT" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Complex relative path scenario works"
          else
            echo "❌ FAIL: Complex relative path scenario failed"
            exit 1
          fi
          
          # Cleanup
          rm -rf test-complex

      # Search Path Preservation Tests (DAT-21189 regression tests)
      - name: Test custom LIQUIBASE_SEARCH_PATH env var is preserved
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Testing that custom LIQUIBASE_SEARCH_PATH environment variable is not overridden..."

          # Create test directory structure
          mkdir -p test-search-path-env/custom-path

          # When using a custom LIQUIBASE_SEARCH_PATH, all changelog files must be in that path
          # This tests that the custom search path is preserved and used correctly
          cat > test-search-path-env/custom-path/main-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <sql>SELECT 'Using custom search path';</sql>
              </changeSet>
          </databaseChangeLog>
          EOF

          # Test with custom search path
          # This verifies that when LIQUIBASE_SEARCH_PATH is set, it is used and not overridden
          set +e
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} \
            --env LIQUIBASE_SEARCH_PATH="/liquibase/custom-path" \
            -v $(pwd)/test-search-path-env/custom-path:/liquibase/custom-path \
            liquibase/liquibase:${{ github.sha }} \
            --changelogFile=main-changelog.xml \
            --url=offline:postgresql \
            validate 2>&1)
          EXIT_CODE=$?
          set -e

          echo "Search path test output: $RESULT"
          echo "Exit code: $EXIT_CODE"

          if echo "$RESULT" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Custom LIQUIBASE_SEARCH_PATH environment variable was preserved"
          else
            echo "❌ FAIL: Custom search path was not respected or overridden"
            echo "Checking if file was found error: $(echo "$RESULT" | grep -i "not found\|cannot find" || echo "No file not found error")"
            exit 1
          fi

          # Cleanup
          rm -rf test-search-path-env

      - name: Test explicit --search-path CLI argument is not overridden
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Testing that explicit --search-path command-line argument is respected..."

          # Create test directory structure
          mkdir -p test-search-path-cli/cli-path

          # Put changelog in the CLI-specified search path
          cat > test-search-path-cli/cli-path/main-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <sql>SELECT 'CLI Search Path Respected';</sql>
              </changeSet>
          </databaseChangeLog>
          EOF

          # Test with explicit --search-path argument
          # This verifies that CLI arguments take precedence and are not overridden
          set +e
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} \
            -v $(pwd)/test-search-path-cli/cli-path:/liquibase/cli-path \
            liquibase/liquibase:${{ github.sha }} \
            --changelogFile=main-changelog.xml \
            --search-path=/liquibase/cli-path \
            --url=offline:postgresql \
            validate 2>&1)
          EXIT_CODE=$?
          set -e

          echo "CLI search path test output: $RESULT"

          if echo "$RESULT" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Explicit --search-path CLI argument was respected"
          else
            echo "❌ FAIL: Explicit search path argument was overridden"
            exit 1
          fi

          # Cleanup
          rm -rf test-search-path-cli

      - name: Test relative paths work WITH custom search path (regression test)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Testing relative paths combined with custom search path (DAT-21189 regression)..."

          # This scenario tests: user provides custom search path and accesses files from within that path
          # The regression was that the entrypoint was injecting additional search paths on top of user's
          mkdir -p test-search-path-combo/shared

          # Main changelog in the custom search path
          cat > test-search-path-combo/shared/main-changelog.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <sql>SELECT 'Custom search path respected';</sql>
              </changeSet>
          </databaseChangeLog>
          EOF

          # Test: custom search path is preserved (regression: PR #414 was overriding this)
          set +e
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} \
            --env LIQUIBASE_SEARCH_PATH="/liquibase/shared" \
            -v $(pwd)/test-search-path-combo/shared:/liquibase/shared \
            liquibase/liquibase:${{ github.sha }} \
            --changelogFile=main-changelog.xml \
            --url=offline:postgresql \
            validate 2>&1)
          EXIT_CODE=$?
          set -e

          echo "Regression test output: $RESULT"

          if echo "$RESULT" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Custom search path preserved correctly (DAT-21189 fixed)"
          else
            echo "❌ FAIL: Custom search path was not preserved (DAT-21189 regression)"
            exit 1
          fi

          # Cleanup
          rm -rf test-search-path-combo

      - name: Test search path not injected when LIQUIBASE_SEARCH_PATH with multiple paths
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "Testing multiple search paths in LIQUIBASE_SEARCH_PATH are preserved..."

          mkdir -p test-multi-search/path1
          mkdir -p test-multi-search/path2

          # Main changelog in path1
          cat > test-multi-search/path1/main.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                             xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                             http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
              <changeSet id="1" author="test">
                  <sql>SELECT 'Multiple paths preserved';</sql>
              </changeSet>
          </databaseChangeLog>
          EOF

          # Test with multiple search paths - this is the real-world scenario that broke (S3 + local paths)
          set +e
          RESULT=$(docker run --rm --env LIQUIBASE_LICENSE_KEY=${{ env.PRO_LICENSE_KEY }} \
            --env LIQUIBASE_SEARCH_PATH="/liquibase/path1,/liquibase/path2" \
            -v $(pwd)/test-multi-search/path1:/liquibase/path1 \
            -v $(pwd)/test-multi-search/path2:/liquibase/path2 \
            liquibase/liquibase:${{ github.sha }} \
            --changelogFile=main.xml \
            --url=offline:postgresql \
            validate 2>&1)
          EXIT_CODE=$?
          set -e

          echo "Multiple search paths test output: $RESULT"

          if echo "$RESULT" | grep -q "No validation errors found"; then
            echo "✅ SUCCESS: Multiple search paths in LIQUIBASE_SEARCH_PATH are preserved"
          else
            echo "❌ FAIL: Multiple search paths were not properly handled"
            exit 1
          fi

          # Cleanup
          rm -rf test-multi-search
