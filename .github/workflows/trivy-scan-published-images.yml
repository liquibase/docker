# Vulnerability scanning for published Docker images using Trivy
# This workflow scans the published images on Docker Hub for vulnerabilities.
# It generates a matrix of image/tag combinations and runs Trivy scans on them.

name: Published Images Vulnerability Scanning

on:
  workflow_dispatch:
    inputs:
      max_tags_to_scan:
        description: "Maximum number of published tags to scan"
        required: false
        default: "20"
  schedule:
    # Run Monday-Friday at 10 AM UTC (published image monitoring)
    - cron: "0 10 * * 1-5" # Run every weekday at 10am UTC

permissions:
  contents: read
  security-events: write # Required for uploading SARIF results to GitHub Security tab
  actions: read # Required for private repositories to get Action run status

jobs:
  generate-matrix:
    name: Generate Scan Matrix
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    env:
      MAX_TAGS: ${{ github.event.inputs.max_tags_to_scan || '10' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate matrix for all image/tag combinations
        id: set-matrix
        run: |
          scripts/generate-dockerhub-matrix.sh

  trivy-scan:
    name: Trivy Scan ${{ matrix.image }}:${{ matrix.tag }}
    runs-on: ubuntu-22.04
    needs: generate-matrix
    permissions:
      contents: read
      security-events: write
      actions: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Pull published image
        run: |
          echo "Pulling ${{ matrix.image }}:${{ matrix.tag }}..."
          docker pull ${{ matrix.image }}:${{ matrix.tag }}

      - name: Extract nested JARs and Python packages for deep scanning
        run: |
          scripts/extract-nested-deps.sh ${{ matrix.image }}:${{ matrix.tag }}

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: "${{ matrix.image }}:${{ matrix.tag }}"
          format: "spdx-json"
          output-file: "sbom.spdx.json"

      - name: Run Trivy vulnerability scanner (Surface Scan)
        id: trivy_scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: "${{ matrix.image }}:${{ matrix.tag }}"
          vuln-type: "os,library"
          scanners: "vuln"
          format: "json"
          output: "trivy-surface.json"
          severity: "HIGH,CRITICAL"
          exit-code: "0"
        continue-on-error: true

      - name: Run Trivy scanner on extracted nested JARs (Deep Scan)
        id: trivy_deep
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: "rootfs"
          scan-ref: "/tmp/extracted-deps"
          vuln-type: "library"
          format: "json"
          output: "trivy-deep.json"
          severity: "HIGH,CRITICAL"
          exit-code: "0"
        continue-on-error: true

      - name: Run Grype scanner on SBOM
        id: grype_scan
        uses: anchore/scan-action@v7
        with:
          sbom: "sbom.spdx.json"
          fail-build: false
          severity-cutoff: high
          output-format: json
        continue-on-error: true

      - name: Save Grype results to file
        if: always()
        env:
          GRYPE_OUTPUT_FORMAT: json
        run: |
          scripts/save-grype-results.sh

      # trivy convert steps assume trivy CLI is available, therefore install the CLI before using those commands across steps.
      - name: Install Trivy CLI
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Convert JSON to SARIF and analyze results
        if: always()
        run: |
          scripts/convert-scan-results.sh

      - name: Create enhanced vulnerability report with parent JAR mapping
        if: always()
        run: |
          scripts/create-enhanced-report.sh ${{ matrix.image }} ${{ matrix.tag }}

      - name: Upload enhanced vulnerability report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: vulnerability-report-${{ matrix.image == 'liquibase/liquibase-secure' && 'secure' || 'community' }}-${{ matrix.tag }}
          path: vulnerability-report-enhanced.md
          retention-days: 90

      - name: Upload Trivy Surface SARIF to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-surface.sarif"
          category: "trivy-${{ matrix.image }}-${{ matrix.tag }}-surface"
        continue-on-error: true

      - name: Check if Trivy Deep SARIF exists
        if: always()
        id: check_trivy_deep
        run: |
          scripts/check-file-exists.sh trivy-deep.sarif exists

      - name: Upload Trivy Deep SARIF to GitHub Security tab
        if: always() && steps.check_trivy_deep.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-deep.sarif"
          category: "trivy-${{ matrix.image }}-${{ matrix.tag }}-deep"
        continue-on-error: true

      - name: Check if Grype SARIF exists
        if: always()
        id: check_grype
        run: |
          scripts/check-file-exists.sh grype-results.sarif exists

      - name: Upload Grype SARIF to GitHub Security tab
        if: always() && steps.check_grype.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "grype-results.sarif"
          category: "trivy-${{ matrix.image }}-${{ matrix.tag }}-grype"
        continue-on-error: true

      - name: Set sanitized names for artifacts
        if: always()
        id: sanitize
        run: |
          SANITIZED_IMAGE=$(echo "${{ matrix.image }}" | tr '/' '-')
          SANITIZED_TAG=$(echo "${{ matrix.tag }}" | tr '/' '-' | tr ':' '-' | tr '.' '-')
          echo "image=$SANITIZED_IMAGE" >> $GITHUB_OUTPUT
          echo "tag=$SANITIZED_TAG" >> $GITHUB_OUTPUT

      - name: Upload Scan Results as Artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: security-report-${{ steps.sanitize.outputs.image }}-${{ steps.sanitize.outputs.tag }}
          path: |
            trivy-surface.json
            trivy-surface.sarif
            trivy-deep.json
            trivy-deep.sarif
            grype-results.json
            sbom.spdx.json
          if-no-files-found: ignore

      - name: Fail job if vulnerabilities found
        run: |
          if [ "${{ env.total_vulns }}" -gt 0 ]; then
            echo "‚ùå Found ${{ env.total_vulns }} HIGH/CRITICAL vulnerabilities in ${{ matrix.image }}:${{ matrix.tag }}"
            echo "  - Surface scan: ${{ env.surface_vulns }} vulnerabilities"
            echo "  - Deep scan (nested JARs): ${{ env.deep_vulns }} vulnerabilities"
            echo "  - Grype SBOM scan: ${{ env.grype_vulns }} vulnerabilities"
            echo ""
            echo "Check the logs above for detailed vulnerability information"
            exit 1
          else
            echo "‚úÖ No HIGH/CRITICAL vulnerabilities found in ${{ matrix.image }}:${{ matrix.tag }}"
          fi

      - name: Append summary to GitHub Actions summary
        if: always()
        run: |
          scripts/append-github-summary.sh ${{ matrix.image }} ${{ matrix.tag }}

  notify-results:
    name: Notify Scan Results
    runs-on: ubuntu-22.04
    needs: [trivy-scan, generate-matrix]
    if: always()
    strategy:
      matrix:
        image: ["liquibase/liquibase", "liquibase/liquibase-secure"]
    steps:
      - name: "Check failures for ${{ matrix.image }}"
        id: check_failures
        uses: actions/github-script@v8
        with:
          script: |
            const image = '${{ matrix.image }}';
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: context.runId
            });

            const scanJobs = jobs.data.jobs.filter(job =>
                job.name.includes(`Trivy Scan ${image}`)
            );

            const failed = scanJobs.filter(job => job.conclusion === 'failure');
            const failedCount = failed.length;
            const totalCount = scanJobs.length;

            core.setOutput('has_failures', failedCount > 0);
            core.setOutput('failed_count', failedCount.toString());
            core.setOutput('total_count', totalCount.toString());

## Since we only fix forward, this Slack notification is redundant.
## It reports vulnerabilities in outdated images even though they've already been fixed.

# - name: "Notify Slack for ${{ matrix.image }}"
# if: steps.check_failures.outputs.has_failures == 'true'
# uses: rtCamp/action-slack-notify@v2
# env:
#     SLACK_COLOR: 'danger'
#     SLACK_MESSAGE: "Security vulnerabilities found in ${{ steps.check_failures.outputs.failed_count }} out of ${{ steps.check_failures.outputs.total_count }} tags for *${{ matrix.image }}*.\nüîé [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
#     SLACK_TITLE: "‚ùå Trivy scan found vulnerabilities in ${{ matrix.image }}"
#     SLACK_USERNAME: liquibot
#     SLACK_WEBHOOK: ${{ secrets.DOCKER_SLACK_WEBHOOK_URL }}
#     SLACK_ICON_EMOJI: ":warning:"
#     SLACK_FOOTER: "${{ github.repository }} - ${{ matrix.image }}"
#     SLACK_LINK_NAMES: true
