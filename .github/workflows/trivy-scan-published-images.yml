# Vulnerability scanning for published Docker images
# This workflow scans published images on Docker Hub for vulnerabilities
# using the reusable vulnerability scanning workflow from build-logic.
#
# NOTE: SARIF results are NOT uploaded to GitHub Security tab to avoid stale alerts.
# Published image vulnerabilities are tracked via workflow artifacts and GitHub Actions summary.
# Only the main branch workflow (trivy.yml) populates the Security tab.

name: Published Images Vulnerability Scanning

on:
  workflow_dispatch:
    inputs:
      max_tags_to_scan:
        description: "Maximum number of published tags to scan"
        required: false
        default: "20"
  schedule:
    # Run Monday-Friday at 10 AM UTC (published image monitoring)
    - cron: "0 10 * * 1-5"

permissions:
  contents: read
  actions: read

jobs:
  generate-matrix:
    name: Generate Scan Matrix
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    env:
      MAX_TAGS: ${{ github.event.inputs.max_tags_to_scan || '10' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate matrix for all image/tag combinations
        id: set-matrix
        run: |
          scripts/generate-dockerhub-matrix.sh

  vulnerability-scan:
    name: Scan ${{ matrix.image }}:${{ matrix.tag }}
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    uses: liquibase/build-logic/.github/workflows/reusable-vulnerability-scan.yml@DAT-21381
    with:
      mode: docker
      source: "${{ matrix.image }}:${{ matrix.tag }}"
      image_name: ${{ matrix.image }}
      image_tag: ${{ matrix.tag }}
      fail_on_vulnerabilities: false
      upload_sarif: false
      generate_sbom: true
      build_logic_ref: DAT-21381
