# Grype SARIF Upload Fix

## Issue

When running the enhanced trivy.yml workflow, you encountered:
```
Path does not exist: grype-results.sarif
Warning: Unexpected input(s) 'output-file', valid inputs are ['image', 'path', 'sbom', 'fail-build', 'output-format', 'severity-cutoff', ...]
```

## Root Cause

The Grype scan step (`anchore/scan-action@v5`) had two issues:

1. **Invalid Parameter**: The action does NOT support `output-file` parameter. Valid inputs are documented in the action's schema, and `output-file` is not one of them.

2. **Default Output Location**: The action outputs results to stdout or a default file location (not `grype-results.sarif`)

The Grype scan step (`anchore/scan-action@v5`) can also fail or not produce output in certain scenarios:

1. **Empty SBOM**: If the SBOM generated by Syft doesn't contain packages that Grype recognizes
2. **Scan Failure**: Network issues, Grype database download problems, or incompatible SBOM format
3. **No Vulnerabilities**: Grype might not create output file if no vulnerabilities are found (depending on configuration)
4. **Community Edition Images**: The `Dockerfile` (community edition) doesn't include `liquibase-license-tracking.jar`, so there are fewer dependencies to scan

## Fix Applied

### 1. Removed Invalid `output-file` Parameter

**Before**:
```yaml
- name: Run Grype scanner on SBOM
  uses: anchore/scan-action@v5
  with:
    sbom: 'sbom.spdx.json'
    fail-build: false
    severity-cutoff: high
    output-format: sarif
    output-file: grype-results.sarif  # ❌ Invalid parameter
```

**After**:
```yaml
- name: Run Grype scanner on SBOM
  if: always()
  id: grype_scan
  uses: anchore/scan-action@v5
  with:
    sbom: 'sbom.spdx.json'
    fail-build: false
    severity-cutoff: high
    output-format: sarif  # ✅ Valid parameter only
  continue-on-error: true
```

### 2. Added Step to Save Grype Results

Since `anchore/scan-action` outputs to a default location, we added a step to move it:

```yaml
- name: Save Grype results to file
  if: always()
  run: |
    # Check for Grype output files in possible locations
    if [ -f "results.sarif" ]; then
      mv results.sarif grype-results.sarif
      echo "✓ Grype SARIF results saved"
    elif [ -f "anchore-scan-results.sarif" ]; then
      mv anchore-scan-results.sarif grype-results.sarif
      echo "✓ Grype SARIF results saved"
    else
      echo "⚠ Grype SARIF output file not found"
    fi
```

### 3. Added File Existence Check to SARIF Upload

```yaml
- name: Upload Grype scan results to GitHub Security tab
  if: always() && hashFiles('grype-results.sarif') != ''
  uses: github/codeql-action/upload-sarif@v4
  with:
    sarif_file: 'grype-results.sarif'
```

This ensures the upload step only runs if the SARIF file actually exists.

### 3. Enhanced Error Logging

Added better logging in the "Combine scan results" step:

```bash
echo "Available scan result files:"
ls -lh *.sarif *.json 2>/dev/null || echo "No scan result files found"

if [ -f grype-results.sarif ]; then
  echo "✓ Grype SBOM Scan: $grype_vulns HIGH/CRITICAL vulnerabilities"
else
  echo "⚠ Grype SBOM Scan: SARIF file not found (scan may have failed or SBOM was empty)"
fi
```

This helps diagnose whether:
- Grype scan failed
- SBOM was empty or incompatible
- File was created but not in the expected location

## Expected Behavior After Fix

### For Community Edition (`Dockerfile`)
```
✓ Trivy Surface Scan: X vulnerabilities
✓ Trivy Deep Scan: Y vulnerabilities (may be 0 - no nested JARs)
⚠ Grype SBOM Scan: SARIF file not found (scan may have failed or SBOM was empty)
```

**Why**: Community edition doesn't have `liquibase-license-tracking.jar`, so deep scan finds less, and Grype may not have much to scan.

### For Secure Edition (`DockerfileSecure`)
```
✓ Trivy Surface Scan: X vulnerabilities
✓ Trivy Deep Scan: Y vulnerabilities (should include customer CVEs)
✓ Grype SBOM Scan: Z vulnerabilities
```

**Why**: Secure edition has the full nested JAR structure with Spring Boot dependencies.

## What This Means for CVE Detection

The **core CVE detection still works** even if Grype fails:

1. **Trivy Surface Scan**: Detects OS packages and top-level libraries ✅
2. **Trivy Deep Scan**: Detects nested JARs and Python packages ✅ (primary detection)
3. **Grype SBOM Scan**: Validates findings ⚠️ (optional validation)

**Customer CVEs should still be detected** by Trivy Deep Scan, even if Grype doesn't run.

## Troubleshooting

### Check Grype Scan Logs

If Grype consistently fails, check the workflow logs for the "Run Grype scanner on SBOM" step:

```bash
gh run view <run_id> --log | grep -A 20 "Run Grype scanner"
```

Common errors:
- `failed to load vulnerability database`: Network/firewall issue
- `no supported packages found in SBOM`: SBOM format incompatibility
- `error parsing SBOM`: Syft generated invalid SBOM

### Verify SBOM Quality

Download the SBOM artifact and inspect:

```bash
gh run download <run_id> --name sbom-secure
cat sbom.spdx.json | jq '.packages | length'
```

Expected: 100+ packages for Secure edition, 50+ for Community edition.

If count is low (<10), Syft may not be detecting packages correctly.

### Test Grype Locally

Pull the image and test Grype manually:

```bash
# Generate SBOM
docker pull liquibase/liquibase-secure:latest
syft liquibase/liquibase-secure:latest -o spdx-json > test-sbom.json

# Scan with Grype
grype sbom:test-sbom.json -o sarif > test-grype.sarif

# Check if SARIF was created
ls -lh test-grype.sarif
cat test-grype.sarif | jq '.runs[].results | length'
```

If this works locally but fails in CI, it's likely a GitHub Actions environment issue.

## Fallback Strategy

If Grype continues to be problematic, you can:

### Option 1: Remove Grype Entirely
- Comment out the "Run Grype scanner" step
- Comment out the "Upload Grype scan results" step
- Remove Grype from vulnerability count aggregation
- Rely solely on Trivy Surface + Deep scans

### Option 2: Run Grype Only for Secure Edition
```yaml
- name: Run Grype scanner on SBOM
  if: always() && matrix.image.dockerfile == 'DockerfileSecure'
  # ... rest of step
```

### Option 3: Switch to Different SBOM Format
Try CycloneDX instead of SPDX:
```yaml
- name: Generate SBOM with Syft
  uses: anchore/sbom-action@v0
  with:
    image: '${{ matrix.image.name }}${{ matrix.image.suffix }}:${{ github.sha }}'
    format: 'cyclonedx-json'  # <-- Changed from spdx-json
    output-file: 'sbom.cyclonedx.json'
```

## Validation

After the fix, the workflow should:
- ✅ Complete successfully even if Grype fails
- ✅ Upload Trivy Surface and Deep SARIFs to GitHub Security tab
- ✅ Optionally upload Grype SARIF if available
- ✅ Report accurate vulnerability counts
- ✅ Detect customer-reported CVEs via Trivy Deep Scan

## Next Steps

1. **Re-run the workflow**: `gh workflow run trivy.yml`
2. **Check the logs**: Look for the "Available scan result files" section
3. **Verify CVE detection**: Focus on Trivy Deep Scan results
4. **Review GitHub Security tab**: Check if nested JAR CVEs are now visible

The workflow is now more resilient and won't fail if Grype encounters issues. The primary CVE detection (Trivy Deep Scan) will still work correctly.
